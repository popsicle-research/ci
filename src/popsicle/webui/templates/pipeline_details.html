{% extends "base.html" %}

{% block title %}Pipeline #{{ pipeline.id }} · POPSICLE CI Dashboard{% endblock %}

{% block content %}
  <div class="mb-4 text-sm">
    <a href="{{ url_for('ui.project_pipelines', repo=repo) }}" class="text-slate-600 hover:text-slate-800">← Back to {{ repo }}</a>
  </div>

  <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">Pipeline #{{ pipeline.id }}</h1>
        <p class="mt-1 text-sm text-slate-600">{{ repo }} · {{ pipeline.branch }}</p>
      </div>
      <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium {{ pipeline.status_class }}">
        {{ pipeline.status }}
      </span>
    </div>

    <dl class="mt-4 grid gap-3 sm:grid-cols-2 text-sm text-slate-700">
      <div>
        <dt class="font-medium text-slate-600">Commit</dt>
        <dd class="mt-1 flex items-center gap-2 font-mono text-xs text-slate-700">
          <span title="{{ pipeline.full_commit }}">{{ pipeline.commit_sha }}</span>
          <button type="button" class="rounded border border-slate-300 px-2 py-1 text-[11px] font-medium text-slate-600 hover:bg-slate-100"
                  onclick="copyText('commit-sha')">Copy</button>
        </dd>
      </div>
      <div>
        <dt class="font-medium text-slate-600">Duration</dt>
        <dd class="mt-1">{{ pipeline.duration }}</dd>
      </div>
      <div>
        <dt class="font-medium text-slate-600">Started</dt>
        <dd class="mt-1">{{ pipeline.start_time }}</dd>
      </div>
      <div>
        <dt class="font-medium text-slate-600">Completed</dt>
        <dd class="mt-1">{{ pipeline.end_time }}</dd>
      </div>
    </dl>
    <div id="commit-sha" class="sr-only">{{ pipeline.full_commit }}</div>
  </section>

  <section class="mt-6 space-y-4">
    <h2 class="text-xl font-semibold text-slate-900">Jobs</h2>
    {% if not jobs %}
      {% set message = 'Jobs will appear here once the pipeline has executed.' %}
      {% include '_empty_state.html' %}
    {% else %}
      {% for job in jobs %}
        <details class="group rounded-lg border border-slate-200 bg-white shadow-sm" open>
          <summary class="flex cursor-pointer list-none items-center justify-between gap-4 px-5 py-4">
            <div>
              <h3 class="text-lg font-medium text-slate-900">{{ job.name }}</h3>
              <p class="mt-1 text-sm text-slate-600">Started {{ job.start_time }} · Ended {{ job.end_time }}</p>
            </div>
            <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium {{ job.status_class }}">{{ job.status }}</span>
          </summary>
          <div class="border-t border-slate-200 px-5 py-4 text-sm text-slate-700">
            <div class="mb-3 flex flex-wrap items-center gap-2">
              <button type="button" class="rounded border border-slate-300 px-3 py-1 text-xs font-medium text-slate-600 hover:bg-slate-100"
                      onclick="copyText('log-{{ job.id }}')">Copy log</button>
              {% if job.is_truncated %}
                <span class="text-xs text-slate-500">Showing first {{ LOG_PREVIEW_LINE_LIMIT }} lines — download for full log.</span>
              {% endif %}
              {% if job.has_log %}
                <a href="{{ url_for('ui.download_job_log', pipeline_id=pipeline.id, job_id=job.id) }}"
                   class="text-xs font-medium text-slate-900 hover:underline">Download log</a>
              {% endif %}
            </div>
            {% if job.has_log %}
              <pre id="log-{{ job.id }}" class="whitespace-pre-wrap overflow-x-auto rounded bg-slate-50 p-4 font-mono text-xs text-slate-800">{{ job.log_preview }}</pre>
            {% else %}
              <p class="text-xs text-slate-500">No log output captured yet.</p>
            {% endif %}
          </div>
        </details>
      {% endfor %}
    {% endif %}
  </section>

  <script>
    function copyText(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const text = el.innerText || el.textContent || '';
      navigator.clipboard.writeText(text);
    }
  </script>
{% endblock %}
